<html>
<head>
    <meta name="viewport" content="width=device-width">
    <script src='file:///android_asset/app.js'></script>
</head>
<body onload="app.Start()" style="background-color:black">
    Motion Detection<br />
    Code: <input type="password" id="AccessKey" value="" size="5" autofocus />
    <select id="CameraNumber">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
    </select>
    <button onclick="xstart();">Start</button>&nbsp;
    <button onclick="app.Exit();">Exit</button>
    <br />
    <video id="xcam" muted autoplay style="width:60%;max-width:640px;"></video>
    <canvas id="xmotion" width="0" height="0"></canvas>
    <br />
    <div id="Monitor" style="color:white;width:100%"></div>
    <div id="WebPageCamInfo" style="color:white;width:100%"></div>
    <input type="hidden" id="debug" value="false" />
    <script src="diff-cam-engine-xjpc.js"></script>
    <script>
        var isSendingLock = false;
        //2019-01-03 JPC add capability for repeat send attempts when internet connectivity is marginal
        var lockTimeStart = (new Date()).getTime();
        var lockTimeout = 30000; //30 seconds

        var xvideo;
        var xcanvas;
        var debug = false;

        //Droidscript test app version with fictional url - edit to your server address
        var requestString = "https://k3s33.example.com/Home/ImagePost";

        //Setup AJAX  refs
        //https://www.w3schools.com/xml/ajax_xmlhttprequest_send.asp
        //https://www.w3schools.com/js/js_ajax_http.asp
        var xmlhttp = new XMLHttpRequest();

        //Called after application is started.
        function OnStart() {
            //alert(testString());
        }

        function xstart() {
            if (document.getElementById("debug").value == "true") {
                debug = true;
                alert("location.href = " + location.href + "\nlocation.pathname = " + location.pathname);
            }
            xvideo = document.getElementById('xcam');
            xcanvas = document.getElementById('xmotion');

            //user permission not needed for an app
            //navigator.mediaDevices.getUserMedia({video:true; audio: false}).
            //    then((stream) => { xvideo.srcObject = stream; });

            //Initialise the DiffCamEngine libary for image capture
            //using the rear-facing camera on phones
            DiffCamEngine.init(
                {
                    scoreThreshold: 50,
                    imageMimeType: "image/jpeg",
                    jpegQuality: 0.7,
                    facingCamera: "environment",
                    captureWidth: 800,
                    captureHeight: 800,
                    //2018-12-26 JPC increase captureIntervalTime from 100ms
                    captureIntervalTime: 200,
                    video: xvideo,
                    motionCanvas: xcanvas,
                    initSuccessCallback: initSuccess,
                    initErrorCallback: initError,
                    captureCallback: xcapture
                });

            //Initialise AJAX
            //setup AJAX
            xmlhttp.onreadystatechange = function () {
                ajaxCallback();
            };

        }

        function initSuccess() {
            DiffCamEngine.start();
        }

        function initError() {
            alert('Error on camera initialisation');
        }

        function xcapture(payload) {
            //2019-01-03 JPC add capability for repeat send attempts when internet connectivity is marginal
            var timeStart = (new Date()).getTime();
            if (timeStart > lockTimeStart + lockTimeout) {
                isSendingLock = false;
            }

            if (isSendingLock) return;
            if (payload.hasMotion) {
                try {
                    var request = payload.getURL();
                    var requestCheck = request.slice(0, 324);
                    //app version needs shorter data sample display
                    document.getElementById("Monitor").innerText = request.length + ".." + requestCheck.slice(300, 305) + "..";

                    var formData = new FormData();
                    formData.append("CameraNumber", document.getElementById("CameraNumber").value);
                    formData.append("AccessKey", document.getElementById("AccessKey").value);
                    //20181216 JPC change from image/png to image/jpeg means that we need slice(headerLength) rather than slice(23) or slice(22)
                    headerLength = requestCheck.indexOf(";base64,") + 8;
                    //if (debug) alert("headerLength = " + headerLength + " of " + requestCheck);
                    formData.append("ImageBase64", request.slice(headerLength));
                    //appPath only applies to web app version, phone app server is assigned above
                    //var requestString = appPath() + "Home/ImagePost";
                    document.getElementById("WebPageCamInfo").innerText = "Sending at " + xgetTime();
                    if (debug) document.getElementById("WebPageCamInfo").innerText += " to " + requestString;
                    //throw new Error("Test error");

                    xmlhttp.open("POST", requestString, true);
                    //xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    isSendingLock = true;
                    xmlhttp.send(formData);
                    //2019-01-03 JPC timeout for unlock
                    lockTimeStart = timeStart;
                } catch (ex) {
                    alert("ERROR in capture processing: " + ex.message);
                }
            }
        }


        function ajaxCallback() {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                var response = xmlhttp.responseText;
                isSendingLock = false;
                //our AJAX methods return json strings so can use same json handling
                //function xreceive as SignalR
                xreceive(response);
            }
        }

        //SignalR and AJAX responses in json format both handled by this one function
        function xreceive(response) {
            var jsonObject = JSON.parse(response);
            if (response.indexOf("issuccess") > -1 && !jsonObject.issuccess) {
                alert(jsonObject.message);
            } else if (jsonObject.categoryid && jsonObject.categoryid == 20) {
                if (jsonObject.debug) debug = true;
                document.getElementById("Monitor").innerText = "AJAX connection is ready.";
                hasReadSettings = true;
            } else if (jsonObject.categoryid && jsonObject.categoryid == 21) {
                document.getElementById("WebPageCamInfo").innerText = "Image saved OK at " + xgetTime() + ".";
            } else {
                alert(response + "ERROR: Data from server is badly formatted or otherwise not making sense.")
            }
            //if (debug) DebugDisplay(response);
        }

        function xgetTime() {
            var d = new Date();
            var hours = ("00" + d.getHours()).slice(-2);
            var minutes = ("00" + d.getMinutes()).slice(-2);
            var seconds = ("00" + d.getSeconds()).slice(-2);
            var milliseconds = (d.getMilliseconds() + "000").slice(2);
            nowTime = hours + ":" + minutes + ":" + seconds + "." + milliseconds;
            return nowTime;
        }

    </script>
</body>
</html>
